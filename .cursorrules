# DoAi.Me - YouTube Agent Farm

## 프로젝트 개요
Galaxy S9 500대를 이용한 YouTube 자동 시청 시스템.
Supabase(DB) → Next.js(웹앱) → Node.js Agent(PC) → Xiaowei(디바이스 제어) → Galaxy S9(YouTube 앱)

## 기술 스택
- **웹앱**: Next.js 14 (App Router), React, TypeScript, Tailwind, shadcn/ui
- **Agent**: Node.js (CommonJS, .js 파일), WebSocket
- **DB**: Supabase (PostgreSQL), REST API
- **디바이스 제어**: Xiaowei 클라이언트 (WebSocket + ADB)
- **배포**: Vercel (웹앱), Windows PC (Agent)

## 아키텍처 플로우
```
videos(active) → VideoDispatcher(60s) → jobs + job_assignments(pending)
→ TaskExecutor(15s poll) → _watchVideoOnDevice() → Xiaowei ADB → Galaxy S9
→ completed → VideoDispatcher가 추가 assignment 생성 (target_views까지)
```

## 프로젝트 구조
```
doai.me/
├── app/                    # Next.js App Router
│   ├── api/               # API Routes
│   └── dashboard/         # 대시보드 UI
├── lib/                   # 공유 라이브러리
├── agent/                 # PC Agent (Node.js CommonJS)
│   ├── agent.js          # 메인 엔트리
│   ├── task-executor.js  # 태스크 실행 엔진
│   ├── video-dispatcher.js
│   ├── xiaowei-client.js # Xiaowei WebSocket
│   └── supabase-sync.js
├── docs/                  # 프로젝트 문서 (Cursor 참조용)
│   ├── architecture.md
│   ├── known-issues.md
│   └── xiaowei-api.md
└── tests/
```


async/await (콜백 금지)
JSDoc 또는 TypeScript 타입 명시
console.log 금지 → logger 사용
환경변수는 config.js에서만
하드코딩 시크릿 금지

## 모듈 규칙

독립 실행 가능: node src/youtube/search.js --test
모듈 간 require는 index.js export만
순환 require 금지
전역 상태 공유 금지
DB 접근은 models.js 통해서만

## ADB + XML 규칙

기기 조작은 반드시 src/adb/client.js 경유
좌표 하드코딩 절대 금지 — XML bounds에서 추출
resource-id 셀렉터 우선 → text → class → bounds
셀렉터는 selectors.js에 중앙 관리
매 액션 사이 800~2500ms 랜덤 딜레이
패턴: dump → find → action → delay → dump → verify
동시 ADB 호출 수 제한 — 반드시 DevicePool.semaphore 통해서

## Supabase 규칙

클라이언트 초기화: src/common/supabase.js 1곳
Realtime 구독은 orchestrator에서만
미션 가져갈 때 즉시 status 업데이트 (중복 방지)

## Vercel API 규칙

응답: { success: boolean, data?: any, error?: string }
Supabase 서버 클라이언트: web/lib/supabase-server.js


## 기기 넘버링 체계
항목형식예시PCPC{00-04}PC00(테스트), PC01~04(운영)기기{001-100}001, 050, 100기기 코드PC번호-기기번호PC01-001 (시스템 UNIQUE)

## PC Agent 실행 모델
node src/agent.js --pc=PC01 --profile=normal

시작 시:
  1. config 로드 + Supabase 연결
  2. adb devices로 연결된 기기 탐색
  3. Supabase에 PC + 기기 등록/업데이트
  4. Realtime 구독 시작 (missions WHERE target_pc=PC01)
  5. 하트비트 루프 시작 (30초)

메인 루프:
  - 미션 수신 → DevicePool에 enqueue
  - DevicePool이 batchSize/concurrency에 맞춰 실행
  - 결과 Supabase에 보고

백그라운드:
  - 30초: 하트비트 (기기 상태 일괄 보고)
  - 6시간: 전체 기기 최적화
  - Realtime 끊김 감지: 자동 재연결 + pending 미션 보완 조회

## 금지 사항

좌표 하드코딩
동기 ADB 호출 (execSync)
모듈 간 순환 require
전역 상태 공유
bare catch (에러 무시)
console.log (logger 사용)
하드코딩 시크릿
models.js 우회한 DB 직접 호출
src/adb/ 우회한 ADB 직접 exec
DevicePool.semaphore 우회한 ADB 동시 호출

## ⚠️ 핵심 규칙
1. DB 쿼리 시 반드시 `docs/supabase-schema.md` 또는 `.cursor/rules/supabase-schema.mdc` 참조
2. Agent 코드는 CommonJS만 (.js, require/module.exports)
3. videos.id = YouTube Video ID (UUID 아님!), channels.id = YouTube Channel ID
4. job_assignments에 `updated_at` 컬럼 없음
5. Agent는 Windows에서만 실행 (WSL 아님)
6. 코딩 컨벤션
6.1 일반