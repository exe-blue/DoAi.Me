# ADR-001: v2.1 Serverless Architecture Migration

**Status**: Accepted
**Date**: 2026-02-12
**Deciders**: Development Team
**Related Commits**: `4ac9370`

---

## Context

DoAi.Me v1은 FastAPI 백엔드, Celery + Redis 태스크 큐, uiautomator2 기반 디바이스 제어로 구성되었습니다. 이 아키텍처는 다음 문제점을 가지고 있었습니다:

1. **인프라 비용**: VPS 상시 운영 필요
2. **운영 복잡성**: Redis 브로커, Celery 워커 관리 부담
3. **디바이스 제어 한계**: uiautomator2의 불안정성

## Decision

v2.1에서 Serverless 아키텍처로 전면 전환합니다.

| 항목 | v1 (폐기) | v2.1 (신규) |
|------|-----------|-------------|
| 백엔드 | FastAPI (자체 서버) | Vercel API Routes |
| 태스크 큐 | Celery + Redis | Supabase Realtime + Xiaowei |
| 디바이스 제어 | uiautomator2 (Python) | Xiaowei WebSocket API + AutoJS |
| 워커 | Celery Worker (Python) | Node.js Agent |
| 인프라 | VPS 상시 운영 | Serverless (사용량 기반) |

### 핵심 원칙

1. **서버 없는 아키텍처**: Supabase + Vercel만으로 운영
2. **Xiaowei 최대 활용**: 31개 API로 디바이스 제어, Action 녹화/재생
3. **프리셋 기반 실행**: 반복 작업은 Xiaowei Action으로 녹화 후 API 호출로 재실행
4. **DB 중심 로깅**: 모든 명령/결과를 Supabase에 기록

## Consequences

### Positive

- 인프라 비용 절감 (사용량 기반 과금)
- 운영 복잡성 감소 (Redis, Celery 제거)
- Xiaowei의 안정적인 디바이스 제어

### Negative

- Vercel Serverless 함수 제한 (10초 타임아웃 등)
- Supabase 의존도 증가

## Implementation

```
doai.me/
├── app/                     # Next.js 14 App Router
│   ├── api/                 # Vercel API Routes (19개)
│   └── dashboard/           # 대시보드 페이지
├── agent/                   # Node PC Agent (6개 모듈)
│   ├── agent.js             # 메인 오케스트레이터
│   ├── xiaowei-client.js    # WebSocket 클라이언트
│   └── supabase-sync.js     # Supabase 동기화
└── supabase/
    └── migrations/          # SQL 마이그레이션
```

---

## References

- [ARCHITECTURE.md](../../ARCHITECTURE.md)
- Commit: `4ac9370` - "chore: v2.1 기초 구축"
