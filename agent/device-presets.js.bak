const _sleep=(ms)=>new Promise(r=>setTimeout(r,ms));const _randInt=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;function extractValue(res,serial){if(!res||!res.data)return'';if(typeof res.data==='string')return res.data.trim();if(serial&&res.data[serial])return String(res.data[serial]).trim();const vals=Object.values(res.data);if(vals.length>0)return String(vals[0]).trim();return'';}async function optimize(xiaowei,serial,options={}){const log=[];const cmds=[{cmd:'settings put system accelerometer_rotation 0',desc:'자동회전 끄기'},{cmd:'settings put system user_rotation 0',desc:'세로 고정'},{cmd:'settings put system screen_off_timeout 2147483647',desc:'화면 꺼짐 방지'},{cmd:'svc power stayon usb',desc:'USB 화면 유지'},{cmd:'settings put system screen_brightness_mode 0',desc:'밝기 자동 끄기'},{cmd:'settings put system screen_brightness 0',desc:'밝기 최소'},{cmd:'media volume --stream 3 --set 0',desc:'미디어 볼륨 0'},{cmd:'media volume --stream 1 --set 0',desc:'벨소리 0'},{cmd:'media volume --stream 5 --set 0',desc:'알림 0'},{cmd:'settings put global zen_mode 1',desc:'DND 켜기'},{cmd:'wm size 1080x1920',desc:'해상도 1080x1920'},{cmd:'wm density 420',desc:'밀도 420'},{cmd:'settings put global window_animation_scale 0',desc:'창 애니메이션 끄기'},{cmd:'settings put global transition_animation_scale 0',desc:'전환 애니메이션 끄기'},{cmd:'settings put global animator_duration_scale 0',desc:'애니메이터 끄기'},{cmd:'settings put global auto_time 1',desc:'자동 시간'},{cmd:'setprop persist.sys.timezone Asia/Seoul',desc:'시간대 서울'},{cmd:'input keyevent KEYCODE_WAKEUP',desc:'화면 깨우기'}];console.log(`[Optimize] ${serial.substring(0,6)} Starting (${cmds.length} commands)`);for(const item of cmds){try{await xiaowei.adbShell(serial,item.cmd);log.push({desc:item.desc,status:'ok'});console.log(`   ${item.desc}`);}catch(err){log.push({desc:item.desc,status:'error'});console.warn(`   ${item.desc}: ${err.message}`);}await _sleep(300);}try{const pkgRes=await xiaowei.adbShell(serial,'pm list packages com.android.adbkeyboard');const pkgVal=extractValue(pkgRes,serial);if(pkgVal.includes('com.android.adbkeyboard')){await xiaowei.adbShell(serial,'ime enable com.android.adbkeyboard/.AdbIME');await _sleep(200);await xiaowei.adbShell(serial,'ime set com.android.adbkeyboard/.AdbIME');console.log('   ADBKeyboard 기본 입력기 전환');}else{console.log('   ADBKeyboard 미설치  스킵');}}catch(err){console.warn(`   ADBKeyboard: ${err.message}`);}const ok=log.filter(l=>l.status==='ok').length;const errs=log.filter(l=>l.status==='error').length;console.log(`[Optimize] ${serial.substring(0,6)} Done (${ok} ok, ${errs} errors)\n`);return{ok,errors:errs};}module.exports={optimize,extractValue};
