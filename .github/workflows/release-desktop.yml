name: Release Desktop (Electron)

on:
  push:
    tags:
      - "v1.0"
      - "v1.0.0"

jobs:
  release:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build desktop
        run: pnpm --filter @doai/desktop run dist

      - name: Create latest.yml for electron-updater
        run: |
          $version = (Get-Content apps/desktop/package.json | ConvertFrom-Json).version
          $exe = Get-ChildItem apps/desktop/release/*.exe | Where-Object { $_.Name -match 'Setup' } | Select-Object -First 1
          if (-not $exe) { $exe = Get-ChildItem apps/desktop/release/*.exe | Select-Object -First 1 }
          if ($exe) {
            $hash = (Get-FileHash -Path $exe.FullName -Algorithm SHA512).Hash
            $date = Get-Date -Format "yyyy-MM-ddTHH:mm:ss.fffZ"
            "version: $version`npath: $($exe.Name)`nsha512: $hash`nreleaseDate: $date" | Out-File -FilePath apps/desktop/release/latest.yml -Encoding utf8
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          prerelease: false
          files: |
            apps/desktop/release/*.exe
            apps/desktop/release/latest.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
