name: policy-guard

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  enforce-devcontainer-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure guard script exists
        run: |
          test -f scripts/guard-devcontainer.mjs

      - name: Ensure npm pre* hooks enforce guard
        run: |
          node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json','utf8'));
          const s = (pkg.scripts || {});
          const want = 'node ./scripts/guard-devcontainer.mjs';
          const keys = ['preinstall','prebuild','pretest'];
          for (const k of keys) {
            if (!s[k]) { console.error('Missing script:', k); process.exit(1); }
            if (!String(s[k]).includes('scripts/guard-devcontainer.mjs')) {
              console.error('Script does not call guard:', k, '=>', s[k]);
              process.exit(1);
            }
          }
          console.log('OK: guard hooks present');
          "

      - name: Block forbidden artifacts in PR
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          # Compare against PR base
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff --name-only origin/${{ github.base_ref }}...HEAD > /tmp/changed_files.txt

          echo "Changed files:"
          cat /tmp/changed_files.txt

          # Forbidden patterns (adjust as needed)
          if grep -E -i '(^|/)(logs/|farm_logs/)|\.log$|\.bak$|\.backup$|(^|/)_archive/|(^|/)\.env($|\.)' /tmp/changed_files.txt; then
            echo "Forbidden artifacts detected in changes."
            exit 1
          fi

          echo "OK: no forbidden artifacts detected"
